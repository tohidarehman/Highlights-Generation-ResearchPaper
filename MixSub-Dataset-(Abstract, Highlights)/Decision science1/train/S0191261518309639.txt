 Macroscopic fundamental diagram has been widely used for aggregate modeling of urban traffic network dynamics to tackle the dimensionality problem of microscopic approaches . This paper contributes to the state of the art by proposing a dynamic user equilibrium model that enables simultaneous route choice and departure time choice under the MFD framework for various applications such as park and ride vehicle dispatching and relocation . To better capture the traffic flow propagation and to adapt to the fast time varying demand the state dependent travel time function is integrated into the MFD dynamics as an endogenous time varying delay . The multi region MFD dynamics with saturated state and inflow constraints is then used as the network loading model to formulate the DUE model through the lens of the differential variational inequality . Necessary conditions for the DUE are analytically derived using the Pontryagin minimum principle . Difficulties raised in handling the dynamic state dependent nonlinear travel time functions state and inflow constraints are addressed without model linearization nor enforcing constant delay assumption as conventionally done in the literature . The additional cost induced by inflow capacity and accumulation constraints can capture the hypercongestion represented by the downward sloping part of the MFD without actually activating traffic congestion . Numerical examples solved by using time discretization solution algorithm illustrate the DUE characteristics and the corresponding dynamic external costs induced by constraints .

@highlight Optimal control framework for general multi region MFD systems with time delays with simultaneous route choice and departure time choice under capacity constraints.
@highlight Analytical dynamic equilibrium conditions for dynamic user equilibrium DUE .
@highlight DUE with minimum generalized travel cost by minimizing individual travel cost.
@highlight MFD model with time delay for capturing flow propagation considering the endogenous time varying delay.
@highlight Side constraint to guarantee FIFO conditions for nonlinear travel time functions.
